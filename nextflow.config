/*
========================================================================================
    Nextflow Configuration for REPUN Pipeline
========================================================================================
    AI Use Disclosure:
    This configuration utilized Anthropic's Claude Code (Claude Sonnet 4.5) for
    pipeline development and optimization. All configurations have been reviewed
    and validated by NIST researchers.
========================================================================================
*/

// =============================================================================
// Manifest
// =============================================================================

manifest {
    name            = 'repun-pipeline'
    author          = 'ND Olson'
    description     = 'Nextflow pipeline for running Repun on multiple samples with S3/CRAM support'
    version         = '1.1.0'
    nextflowVersion = '!>=21.04.0'
    mainScript      = 'main.nf'
}

// =============================================================================
// Helper Functions
// =============================================================================

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   WARNING: max_memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   WARNING: max_time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min(obj, params.max_cpus as int)
        } catch (all) {
            println "   WARNING: max_cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}

// =============================================================================
// Global Default Params
// =============================================================================

params {
    // Required inputs
    input                   = null
    ref                     = null
    truth                   = null

    // Output options
    outdir                  = 'results'
    cache_dir               = "${params.outdir}/s3_cache"
    tracedir                = "${params.outdir}/pipeline_info"

    // Local file cache - check this directory for files before downloading from S3
    // Set to 'false' to disable local file detection
    local_data_dir          = 'data'

    // Repun somatic mode parameters
    somatic_mode            = true
    min_af                  = 0.01
    max_af_somatic          = 0.08
    vaf_threshold           = 0.01
    chunk_size				= 50000000

    // AWS configuration
    aws_profile             = 'mdic'

    // Pipeline options
    help                    = false

    // Max resource options
    max_cpus                = 24
    max_memory              = '386.GB'
    max_time                = '240.h'
}

// =============================================================================
// Container and Environment Configuration
// =============================================================================

docker {
    enabled         = true
    runOptions      = '-u $(id -u):$(id -g)'
    temp            = 'auto'
}

conda {
    enabled         = true
    useMamba        = true
}

// =============================================================================
// AWS Configuration
// =============================================================================

aws {
    profile         = 'mdic'
    client {
        maxConnections      = 20
        connectionTimeout   = 10000
        uploadMaxThreads    = 4
        uploadChunkSize     = '100MB'
        uploadStorageClass  = 'INTELLIGENT_TIERING'
        storageEncryption   = 'AES256'
    }
}

// =============================================================================
// Process Configuration
// =============================================================================

process {
    // Default resources
    cpus   = { check_max( 4, 'cpus' ) }
    memory = { check_max( 32.GB * task.attempt, 'memory' ) }
    time   = { check_max( 24.h  * task.attempt, 'time' ) }

    // Error strategy
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific configurations
    withLabel: 'process_repun' {
        cpus   = { check_max( 12, 'cpus' ) }
        memory = { check_max( 128.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h  * task.attempt, 'time' ) }
    }
}

// =============================================================================
// Execution Profiles
// =============================================================================

profiles {

    // Standard profile (default) - Moderate resources
    standard {
        process {
            cpus   = 4
            memory = '32.GB'
        }
    }

    // Local high-resource execution
    local {
        process {
            cpus   = 24
            memory = '350.GB'
        }
    }

    // Debug profile
    debug {
        process.beforeScript = 'echo $HOSTNAME'
        cleanup = false
    }

    // Conda-only profile (disable Docker)
    conda {
        docker.enabled      = false
        conda.enabled       = true
        conda.createTimeout = '2 h'
    }

    // Test profile with minimal resources
    test {
        process {
            cpus   = 2
            memory = '6.GB'
            time   = '1.h'
        }
    }
}

// =============================================================================
// Report and Timeline Configuration
// =============================================================================

timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file    = "${params.tracedir}/execution_report.html"
    overwrite = true
}

trace {
    enabled = true
    overwrite = true
    file    = "${params.tracedir}/execution_trace.txt"
    fields  = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,workdir,scratch,error_action'
}

dag {
    enabled = true
    file    = "${params.tracedir}/pipeline_dag.svg"
    overwrite = true
}

lineage {
    enabled = true
}