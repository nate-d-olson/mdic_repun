/*
========================================================================================
    Nextflow Configuration for REPUN Pipeline
========================================================================================
*/

// =============================================================================
// Manifest
// =============================================================================

manifest {
    name            = 'repun-pipeline'
    author          = 'MDIC Team'
    description     = 'Nextflow pipeline for running Repun on multiple samples with S3/CRAM support'
    version         = '1.0.0'
    nextflowVersion = '!>=21.04.0'
    mainScript      = 'main.nf'
}

// =============================================================================
// Global Default Params
// =============================================================================

params {
    // Output options
    outdir                  = 'results'
    cache_dir               = "${params.outdir}/s3_cache"
    tracedir                = "${params.outdir}/pipeline_info"

    // Max resource options
    max_cpus                = 24
    max_memory              = '386.GB'
    max_time                = '240.h'
}

// =============================================================================
// Container and Environment Configuration
// =============================================================================

docker {
    enabled         = true
    runOptions      = '-u $(id -u):$(id -g)'
    temp            = 'auto'
}

conda {
    enabled         = true
    useMamba        = true
}

// =============================================================================
// AWS Configuration
// =============================================================================

aws {
    profile         = 'mdic'
    client {
        maxConnections      = 20
        connectionTimeout   = 10000
        uploadMaxThreads    = 4
        uploadChunkSize     = '100MB'
        uploadStorageClass  = 'INTELLIGENT_TIERING'
        storageEncryption   = 'AES256'
    }
}

// =============================================================================
// Process Configuration
// =============================================================================

process {
    // Default resources
    cpus   = { check_max( 4, 'cpus' ) }
    memory = { check_max( 32.GB * task.attempt, 'memory' ) }
    time   = { check_max( 24.h  * task.attempt, 'time' ) }

    // Error strategy
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific configurations
    withLabel: 'process_low' {
        cpus   = { check_max( 2, 'cpus' ) }
        memory = { check_max( 8.GB * task.attempt, 'memory' ) }
        time   = { check_max( 4.h  * task.attempt, 'time' ) }
    }

    withLabel: 'process_medium' {
        cpus   = { check_max( 6, 'cpus' ) }
        memory = { check_max( 24.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h  * task.attempt, 'time' ) }
    }

    withLabel: 'process_high' {
        cpus   = { check_max( 12, 'cpus' ) }
        memory = { check_max( 64.GB * task.attempt, 'memory' ) }
        time   = { check_max( 16.h  * task.attempt, 'time' ) }
    }

    // Process-specific settings by name
    withName: 'DOWNLOAD_AND_CONVERT_ALIGNMENT' {
        errorStrategy = 'retry'
        maxRetries    = 3
    }

    withName: 'HANDLE_INDEX' {
        errorStrategy = 'retry'
        maxRetries    = 3
    }

    withName: 'RUN_REPUN' {
        errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
        maxRetries    = 2
    }
}

// =============================================================================
// Execution Profiles
// =============================================================================

profiles {

    // Standard profile (default) - Moderate resources
    standard {
        process {
            cpus   = 4
            memory = '32.GB'
        }
    }

    // Local high-resource execution
    local {
        process {
            cpus   = 24
            memory = '386.GB'

            withLabel: 'process_high' {
                cpus   = 24
                memory = '386.GB'
            }
        }
    }

    // High memory profile for memory-intensive samples
    high_mem {
        process {
            cpus   = 22
            memory = '128.GB'

            withLabel: 'process_high' {
                cpus   = 22
                memory = '128.GB'
            }
        }
    }

    // Debug profile
    debug {
        process.beforeScript = 'echo $HOSTNAME'
        cleanup = false
    }

    // Conda-only profile (disable Docker)
    conda {
        docker.enabled      = false
        conda.enabled       = true
        conda.createTimeout = '2 h'
    }

    // Test profile with minimal resources
    test {
        process {
            cpus   = 2
            memory = '6.GB'
            time   = '1.h'
        }
    }
}

// =============================================================================
// Report and Timeline Configuration
// =============================================================================

timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file    = "${params.tracedir}/execution_report.html"
    overwrite = true
}

trace {
    enabled = true
    file    = "${params.tracedir}/execution_trace.txt"
    fields  = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt,workdir,scratch,error_action'
}

dag {
    enabled = true
    file    = "${params.tracedir}/pipeline_dag.svg"
    overwrite = true
}

// =============================================================================
// Function to Check Maximum Resource Limits
// =============================================================================

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
